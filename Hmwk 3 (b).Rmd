---
title: "R Notebook"
output: html_notebook
---




```{r}
install.packages("sf")

install.packages("dplyr")

install.packages("leaflet")
install.packages("leafsync")



```


```{r}
library(sf)
library(dplyr)
library(leaflet)
library(leafsync)

```

```{r}

# Step 1: Reload contribution data
linkBoston <- "https://github.com/DACSS-Visual/SpatialData/raw/refs/heads/main/data/BostonContrib.xlsx"
bostonCont <- rio::import(linkBoston)

# Step 2: Aggregate contributions
selected_data <- bostonCont %>%
  group_by(Zip, `Tender Type Description`) %>%
  summarise(
    mean_contribution = mean(Amount, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(`Tender Type Description` %in% c("Check", "Credit Card")) %>%
  mutate(Zip = as.character(Zip))

# Step 3: Reload ZIP code map
linkZips <- "https://raw.githubusercontent.com/DACSS-Visual/SpatialData/refs/heads/main/data/zip_codes.json"
bostonZips <- sf::read_sf(linkZips)

# Step 4: Prepare ZIP code column
bostonZips$ZIP5 <- as.character(bostonZips$ZIP5)

# Step 5: Merge and transform map
interactive_map <- bostonZips %>%
  left_join(selected_data, by = c("ZIP5" = "Zip")) %>%
  st_transform(crs = 4326)  # WGS84 for Leaflet

# Step 6: Filter for 'Check' and 'Credit Card' tender types
check_map <- interactive_map %>%
  filter(`Tender Type Description` == "Check")
credit_card_map <- interactive_map %>%
  filter(`Tender Type Description` == "Credit Card")

# Step 7: Define common color scale
common_domain <- range(c(check_map$mean_contribution, credit_card_map$mean_contribution), na.rm = TRUE)
palette_check <- colorNumeric("YlOrRd", domain = common_domain, na.color = "transparent")
palette_credit <- colorNumeric("YlOrRd", domain = common_domain, na.color = "transparent")

# Step 8: Create Leaflet map for 'Check'
leaflet_check <- leaflet(check_map) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~palette_check(mean_contribution),
    fillOpacity = 0.8,
    color = "white",
    weight = 1,
    popup = paste0(
      "ZIP: ", check_map$ZIP5,
      "<br>Mean Contribution: $", round(check_map$mean_contribution, 2)
    )
  ) %>%
  addLegend(
    position = "bottomright",
    pal = palette_check,
    values = ~mean_contribution,
    title = "Mean Contribution (Check)"
  )

# Step 9: Create Leaflet map for 'Credit Card'
leaflet_credit <- leaflet(credit_card_map) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~palette_credit(mean_contribution),
    fillOpacity = 0.8,
    color = "white",
    weight = 1,
    popup = paste0(
      "ZIP: ", credit_card_map$ZIP5,
      "<br>Mean Contribution: $", round(credit_card_map$mean_contribution, 2)
    )
  ) %>%
  addLegend(
    position = "bottomright",
    pal = palette_credit,
    values = ~mean_contribution,
    title = "Mean Contribution (Credit Card)"
  )

# Step 10: Synchronize maps
if (!requireNamespace("leafsync", quietly = TRUE)) {
  install.packages("leafsync")
}
library(leafsync)

# Synchronize the two maps
sync_maps <- leafsync::sync(leaflet_check, leaflet_credit)

# Display the synchronized maps
sync_maps

# Save the synchronized maps
saveRDS(sync_maps, file = "boston_contributions_leaflet_sync_maps.rds")



```


```{r}
# Save synchronized maps as an RDS file
saveRDS(sync_maps, file = "synchronized_maps.rds")

```


