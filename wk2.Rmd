
---
title: "Monthly Trends in COVID-19 Cases and Deaths in Massachusetts (2020-2021)"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---





```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(reshape2)

# Load the dataset
link <- "https://github.com/DACSS-Visual/tabular_bivar_numnum/raw/main/data/covidMA.rds"
covidMA <- readRDS(url(link))

# Aggregate data by month
covidMA_monthly <- aggregate(data = covidMA, cbind(cases, deaths) ~ yearMonth, sum)

# Convert yearMonth to Date format
covidMA_monthly$yearMonth <- as.Date(covidMA_monthly$yearMonth)

# Reshape data for ggplot compatibility
covidMA_monthly_long <- melt(covidMA_monthly, 
                             variable.name = 'type',
                             value.name = 'value',
                             id.vars = 'yearMonth')

# Convert again to ensure Date format consistency
covidMA_monthly_long$yearMonth <- as.Date(covidMA_monthly_long$yearMonth)

# Identify the peak month for annotation
peak_cases <- max(covidMA_monthly$cases)
peak_date <- covidMA_monthly$yearMonth[which.max(covidMA_monthly$cases)]

# Title, subtitle, and caption for rubric compliance
titleText <- "Monthly Trends in COVID-19 Cases and Deaths in Massachusetts (2020-2021)"
sub_titleText <- "Data aggregated by month, showcasing the monthly progression of cases and deaths."
captionText <- "Source: MA - Covid19 Dashboard | Website: https://www.mass.gov/info-details/covid-19-reporting"

# Generate the plot with the updated requirements
covidLines <- ggplot(covidMA_monthly_long, aes(x = yearMonth, y = value, color = type)) +
  geom_line(size = 1) +
  
  # Annotate the highest spike with exact count and date
  geom_text(aes(x = peak_date, y = peak_cases, 
                label = paste("Spike:", format(peak_cases, big.mark=","), "\nDate:", peak_date)), 
            color = "blue", angle = 45, hjust = 0, vjust = -0.5) +

  # Apply log transformation to y-axis
  scale_y_log10(labels = scales::comma) + 
  
  # Customizing color and scales
  scale_x_date(date_breaks = "1 month", date_labels = "%b-%Y") +
  scale_color_manual(values = c("cases" = "blue", "deaths" = "red")) +
  
  # Adding labels and captions
  labs(title = titleText, 
       subtitle = sub_titleText, 
       caption = captionText, 
       x = "Date", 
       y = "Count (Log Scale)", 
       color = "Data Type") +
  
  # Theme adjustments for clarity and minimalism
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90))

# Print the plot explicitly for Flexdashboard rendering
print(covidLines)

# Save the plot for future use in the dashboard
saveRDS(covidLines, file = "covidLines.rds")



```

