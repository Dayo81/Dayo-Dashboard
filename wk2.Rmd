
---
title: "Monthly Trends in COVID-19 Cases and Deaths in Massachusetts (2020-2021)"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---





```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(reshape2)

# Load the dataset
link <- "https://github.com/DACSS-Visual/tabular_bivar_numnum/raw/main/data/covidMA.rds"
covidMA <- readRDS(url(link))

# Aggregate data by month
covidMA_monthly <- aggregate(data = covidMA, cbind(cases, deaths) ~ yearMonth, sum)

# Convert yearMonth to Date format
covidMA_monthly$yearMonth <- as.Date(covidMA_monthly$yearMonth)

# Reshape data for ggplot compatibility
covidMA_monthly_long <- melt(covidMA_monthly, 
                             variable.name = 'type',
                             value.name = 'value',
                             id.vars = 'yearMonth')

# Identify the month with the highest cases (worst month)
worst_month <- as.Date(covidMA_monthly$yearMonth[which.max(covidMA_monthly$cases)])

# Title, Subtitle, and Caption Update
titleText <- "COVID-19 Case Spike and Declining Deaths in MA (2020-21)"
sub_titleText <- "Data aggregated monthly (August 2020 to December 2021) for Massachusetts."
captionText <- "Source: MA - Covid19 Dashboard | Website: https://www.mass.gov/info-details/covid-19-reporting"

# Generate the plot with corrected vertical line and annotation placement
covidLines <- ggplot(covidMA_monthly_long, aes(x = yearMonth, y = value, color = type)) +
  geom_line(size = 1) +
  
  # Corrected vertical line outside aes()
  geom_vline(xintercept = as.numeric(worst_month), linetype = "dashed", color = "black", size = 1) +
  
  # Adding a label near the vertical line
  annotate("text", x = worst_month, y = max(covidMA_monthly$cases), 
           label = "Worst Month", angle = 90, vjust = -0.5, size = 4) +

  # Log transformation applied to Y-axis
  scale_y_log10(labels = scales::comma) + 
  
  # Customizing color and scales
  scale_x_date(date_breaks = "1 month", date_labels = "%b-%Y") +
  scale_color_manual(values = c("cases" = "blue", "deaths" = "red")) +
  
  # Adding labels and captions with spacing adjustments
  labs(title = titleText, 
       subtitle = sub_titleText, 
       caption = captionText, 
       x = "Date", 
       y = "Count (Log Scale)", 
       color = "Data Type") +

  # Adjusting theme for better title and caption spacing
  theme_minimal() +
  theme(
    plot.title.position = "plot",  # Adjusts title position for clarity
    plot.caption = element_text(hjust = 0, size = 10),  # Prevents caption cutoff
    axis.text.x = element_text(angle = 90)
  )

# Print the plot explicitly for Flexdashboard rendering
print(covidLines)

# Save the plot for future use in the dashboard
saveRDS(covidLines, file = "covidLines.rds")



```

